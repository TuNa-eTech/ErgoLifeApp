// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum AuthProvider {
  GOOGLE
  APPLE
}

enum RedemptionStatus {
  PENDING   // Đã đổi, chưa sử dụng
  USED      // Đã sử dụng
  EXPIRED   // Hết hạn (future feature)
}

// ===========================================
// MODELS
// ===========================================

model User {
  id           String       @id @default(uuid())
  firebaseUid  String       @unique @map("firebase_uid")
  provider     AuthProvider
  email        String?      @unique
  displayName  String?      @map("display_name")
  avatarId     Int?         @map("avatar_id")
  
  // House relationship
  houseId      String?      @map("house_id")
  house        House?       @relation("HouseMembers", fields: [houseId], references: [id])
  
  // Economy
  walletBalance Int         @default(0) @map("wallet_balance")
  
  // Push notifications
  fcmToken     String?      @map("fcm_token")
  
  // Task seeding flag
  hasSeededTasks Boolean    @default(false) @map("has_seeded_tasks")
  
  // Streak tracking (Duolingo-style)
  currentStreak    Int       @default(0) @map("current_streak")
  longestStreak    Int       @default(0) @map("longest_streak")
  lastActivityDate DateTime? @map("last_activity_date")
  streakFreezeCount Int      @default(0) @map("streak_freeze_count") // 0-2
  
  // Timestamps
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  // Relations
  activities   Activity[]
  rewards      Reward[]     @relation("RewardCreator")
  redemptions  Redemption[]
  housesOwned  House[]      @relation("HouseOwner")
  customTasks  CustomTask[]

  @@map("users")
}

// ===========================================
// TASK TEMPLATES (CMS-managed)
// ===========================================

model TaskTemplate {
  id              String   @id @default(uuid())
  
  // Task metadata
  metsValue       Float    @map("mets_value")
  defaultDuration Int      @map("default_duration") // minutes
  icon            String   @default("fitness_center")
  animation       String?  // Lottie animation file name
  color           String   @default("#FF6A00")
  category        String   @default("general")
  sortOrder       Int      @default(0) @map("sort_order")
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  translations    TaskTemplateTranslation[]
  
  @@index([isActive, sortOrder])
  @@map("task_templates")
}

model TaskTemplateTranslation {
  id          String       @id @default(uuid())
  
  templateId  String       @map("template_id")
  template    TaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  locale      String       // "en", "vi", etc.
  name        String       // Localized name
  description String?      // Localized description
  
  @@unique([templateId, locale])
  @@map("task_template_translations")
}

// ===========================================
// USER TASKS
// ===========================================

model CustomTask {
  id              String   @id @default(uuid())
  
  // Owner
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id])
  
  // From template or custom
  templateId      String?  @map("template_id") // null = custom task
  
  // Task details
  exerciseName    String   @map("exercise_name")
  taskDescription String?  @map("task_description")
  durationMinutes Int      @map("duration_minutes")
  metsValue       Float    @default(3.5) @map("mets_value")
  icon            String   @default("fitness_center")
  animation       String?  // Lottie animation file name
  color           String   @default("#FF6A00")
  
  // User preferences
  sortOrder       Int      @default(0) @map("sort_order")
  isHidden        Boolean  @default(false) @map("is_hidden")
  isFavorite      Boolean  @default(false) @map("is_favorite")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([userId, isHidden, sortOrder])
  @@map("custom_tasks")
}

model House {
  id          String   @id @default(uuid())
  name        String
  inviteCode  String   @unique @default(cuid()) @map("invite_code")
  isPersonal  Boolean  @default(false) @map("is_personal")
  
  // Owner
  createdById String   @map("created_by")
  createdBy   User     @relation("HouseOwner", fields: [createdById], references: [id])
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  members     User[]   @relation("HouseMembers")
  activities  Activity[]
  rewards     Reward[]
  redemptions Redemption[]

  @@map("houses")
}

model Activity {
  id              String   @id @default(uuid())
  
  // References
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id])
  houseId         String   @map("house_id")
  house           House    @relation(fields: [houseId], references: [id])
  
  // Task details
  taskName        String   @map("task_name")
  durationSeconds Int      @map("duration_seconds")
  metsValue       Float    @map("mets_value")
  
  // Points
  pointsEarned    Int      @map("points_earned")
  bonusMultiplier Float    @default(1.0) @map("bonus_multiplier")
  
  // Completion
  completedAt     DateTime @default(now()) @map("completed_at")

  @@index([houseId, completedAt])
  @@index([userId, completedAt])
  @@map("activities")
}

model Reward {
  id          String   @id @default(uuid())
  
  // References
  houseId     String   @map("house_id")
  house       House    @relation(fields: [houseId], references: [id])
  creatorId   String   @map("creator_id")
  creator     User     @relation("RewardCreator", fields: [creatorId], references: [id])
  
  // Reward details
  title       String
  cost        Int
  icon        String   @default("gift")
  description String?
  
  // Status
  isActive    Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  redemptions Redemption[]

  @@index([houseId, isActive])
  @@map("rewards")
}

model Redemption {
  id          String           @id @default(uuid())
  
  // References
  userId      String           @map("user_id")
  user        User             @relation(fields: [userId], references: [id])
  rewardId    String           @map("reward_id")
  reward      Reward           @relation(fields: [rewardId], references: [id])
  houseId     String           @map("house_id")
  house       House            @relation(fields: [houseId], references: [id])
  
  // Snapshot at redemption time
  rewardTitle String           @map("reward_title")
  pointsSpent Int              @map("points_spent")
  
  // Status
  status      RedemptionStatus @default(PENDING)
  
  // Timestamps
  redeemedAt  DateTime         @default(now()) @map("redeemed_at")
  usedAt      DateTime?        @map("used_at")

  @@index([userId, redeemedAt])
  @@index([houseId, redeemedAt])
  @@map("redemptions")
}
